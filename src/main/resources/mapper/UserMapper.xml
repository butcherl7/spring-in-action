<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="top.funsite.spring.action.mapper.UserMapper">
    <resultMap id="UserMap" type="top.funsite.spring.action.domin.entity.User">
        <id column="ID" property="id" jdbcType="BIGINT"/>
        <result column="USERNAME" property="username" jdbcType="VARCHAR"/>
        <result column="PASSWORD" property="password" jdbcType="VARCHAR"/>
        <result column="UNLOCKED_TIME" property="unlockedTime" jdbcType="TIMESTAMP"/>
        <result column="ENABLED" property="enabled" jdbcType="BOOLEAN"/>
        <result column="CREATED_TIME" property="createdTime" jdbcType="TIMESTAMP"/>
        <result column="UPDATED_TIME" property="updatedTime" jdbcType="TIMESTAMP"/>
        <collection property="roles" ofType="top.funsite.spring.action.domin.entity.Role">
            <id column="R_NAME" property="name" jdbcType="VARCHAR"/>
            <result column="R_ENABLED" property="enabled" jdbcType="BOOLEAN"/>
            <result column="R_CREATED_TIME" property="createdTime" jdbcType="TIMESTAMP"/>
            <collection property="permissions" ofType="top.funsite.spring.action.domin.entity.Permission">
                <id column="P_NAME" property="name" jdbcType="VARCHAR"/>
                <result column="P_ENABLED" property="enabled" jdbcType="BOOLEAN"/>
                <result column="P_CREATED_TIME" property="createdTime" jdbcType="TIMESTAMP"/>
            </collection>
        </collection>
    </resultMap>

    <select id="selectByUsername" resultMap="UserMap">
        SELECT A.ID,
               A.USERNAME,
               A.PASSWORD,
               A.UNLOCKED_TIME,
               A.ENABLED,
               A.CREATED_TIME,
               A.UPDATED_TIME,
               C.NAME         R_NAME,
               C.ENABLED      R_ENABLED,
               C.CREATED_TIME R_CREATED_TIME,
               E.NAME         P_NAME,
               E.ENABLED      P_ENABLED,
               E.CREATED_TIME P_CREATED_TIME
        FROM SYS_USER A
                 LEFT JOIN SYS_USER_ROLE B ON A.ID = B.UID
                 LEFT JOIN SYS_ROLE C ON B.ROLE_NAME = C.NAME AND C.ENABLED = TRUE
                 LEFT JOIN SYS_ROLE_PERMISSION D ON C.NAME = D.ROLE_NAME
                 LEFT JOIN SYS_PERMISSION E ON D.PERMISSION_NAME = E.NAME AND E.ENABLED = TRUE
        WHERE A.USERNAME = #{username}
    </select>
</mapper>
